<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NCERT Doubt Solver</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      }
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body class="bg-gray-100 h-screen flex flex-col">

<header class="bg-indigo-600 text-white p-4 text-xl font-bold">
  üìò NCERT Doubt Solver (Class 5‚Äì10)
</header>

<main class="flex-grow p-4 flex flex-col">

  <div class="flex gap-4 mb-3">
    <select id="grade" class="p-2 border rounded">
      <option value="10">Grade 10</option>
      <option value="9">Grade 9</option>
      <option value="8">Grade 8</option>
      <option value="7">Grade 7</option>
      <option value="6">Grade 6</option>
      <option value="5">Grade 5</option>
    </select>

    <select id="subject" class="p-2 border rounded">
      <option value="Mathematics">Mathematics</option>
      <option value="Science">Science</option>
      <option value="Social Science">Social Science</option>
      <option value="English">English</option>
    </select>
  </div>

  <div id="chat" class="flex-grow bg-white p-4 rounded overflow-y-auto mb-3"></div>

  <div class="flex">
    <input id="input"
           class="flex-grow p-3 border rounded-l"
           placeholder="Ask your doubt (Class 5‚Äì10 only)..." />
    <button onclick="sendMessage()"
            class="bg-indigo-600 text-white px-5 rounded-r">
      Send
    </button>
  </div>
</main>

<script>
  function isOutOfScope(text) {
    const outScopeKeywords = [
      "integration", "differentiate", "derivative",
      "limit", "matrix", "determinant",
      "vector", "probability density",
      "laplace", "electromagnetic",
      "organic chemistry", "inorganic",
      "trigonometric identities",
      "class 11", "class 12", "jee", "neet"
    ];

    return outScopeKeywords.some(word =>
      text.toLowerCase().includes(word)
    );
  }

  function autoMath(text) {
    text = text.replace(/([a-zA-Z0-9])\^([0-9]+)/g, "$1^{$2}");
    text = text.replace(/(\d+)\s*\/\s*(\d+)/g, "\\frac{$1}{$2}");
    text = text.replace(
      /(^|<br>|\\n)([^<]*=[^<]*)(?=<br>|\\n|$)/g,
      "$1$$$2$$"
    );
    return text;
  }

  function formatAIText(text) {
    text = autoMath(text);
    return text
      .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
      .replace(/\n/g, "<br>");
  }

  async function sendMessage() {
    const input = document.getElementById("input");
    const chat = document.getElementById("chat");
    const messageText = input.value.trim();

    if (!messageText) return;

    const grade = parseInt(document.getElementById("grade").value);
    const subject = document.getElementById("subject").value;

    chat.innerHTML += `
      <div class="mb-2 text-right">
        <b>You:</b> ${messageText}
      </div>
    `;
    input.value = "";

    if (grade > 10 || isOutOfScope(messageText)) {
      chat.innerHTML += `
        <div class="mb-4 text-left text-red-600">
          <b>AI:</b><br>
           I don‚Äôt know. This question is <b>out of scope</b>.<br>
           I can help only with <b>NCERT Class 5‚Äì10</b> topics.
        </div>
      `;
      chat.scrollTop = chat.scrollHeight;
      return;
    }

    try {
      const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messageText, grade, subject })
      });

      const data = await res.json();
      const aiResponseText = formatAIText(data.answer);

      chat.innerHTML += `
        <div class="mb-4 text-left">
          <b>AI:</b><br>
          ${aiResponseText}
        </div>
      `;

      MathJax.typesetPromise();

    } catch (err) {
      chat.innerHTML += `
        <div class="text-red-600">‚ö†Ô∏è Error getting response</div>
      `;
      console.error(err);
    }

    chat.scrollTop = chat.scrollHeight;
  }

  document.getElementById("input").addEventListener("keypress", function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
</script>

</body>
</html>
